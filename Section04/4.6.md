4.6. 服务器推送
============================
服务器推送是一种交互模式，它允许服务器在客户端发出指示的请求之前将请求-响应交换推送到客户端。这将网络使用与潜在的延迟增益进行了权衡。HTTP/3 服务器推送类似于[HTTP/2]第8.2节中描述的内容，但它使用不同的机制。

服务器为每个服务器推送分配了一个唯一的推送 ID。推送 ID 用于在 HTTP/3 连接的整个生命周期内引用不同上下文中所关联的推送。

推送ID空间从零开始，到 MAX_PUSH_ID 帧设置的最大值结束。特别是，服务器在客户端发送 MAX_PUSH_ID 帧之前无法推送。客户端发送 MAX_PUSH_ID 帧来控制服务器可以承诺的推送次数。服务器应该从零开始按顺序使用推送 ID。当没有发送 MAX_PUSH_ID 帧或流引用的推送 ID 大于最大推送 ID 时，客户端必须将收到推送流视为 H3_ID_ERROR 类型的连接错误。

推送 ID 被用于携带请求消息的控制数据和标头字段的一个或多个 PUSH_PROMISE 帧。这些帧在生成推送的请求流上发送。当在多个请求流上承诺相同的推送 ID 时，解压缩的请求字段部分必须以相同的顺序包含相同的字段，并且每个字段中的名称和值必须完全相同。

之后推送 ID 包含在最终履行这些承诺的推送流中。推送流识别它履行的承诺的推送 ID，然后包含对承诺请求的响应，如第4.1节所述。

最后，推送 ID 可以在 CANCEL_PUSH 帧中使用；请参阅第7.2.3节。客户端使用此帧表示他们不希望接收承诺的资源。服务器使用此帧表示他们不会履行先前的承诺。

并非所有请求都可以推送。服务器可以推送具有以下属性的请求：

* 可缓存；参见[HTTP]的第9.2.3节
* 安全；参见[HTTP]的第9.2.1节
* 不包括请求内容或尾标头部分

具有权威性的服务器必须在 :authority 伪标头字段中包含一个值。如果客户端尚未验证推送请求所指示的源的连接，它必须执行与在连接上发送请求给该源的相同的验证过程；见第3.3节。如果此验证失败，客户端不得认为服务器对该来源具有权威性。

客户端应该在收到 PUSH_PROMISE 帧时发送一个 CANCEL_PUSH 帧，该帧携带一个不可缓存、不知道是否安全的、指示请求内容存在的请求，或者它认为服务器不权威的请求。任何相应的响应都不能够被使用或者缓存。

每个推送的响应与一个或多个客户端请求相关联。推送与接收 PUSH_PROMISE 帧的请求流相关联。同一服务器推送可以与多个请求流上使用具有相同推送 ID 的 PUSH_PROMISE 帧的其他客户端请求相关联。这些关联不会影响协议的操作，但用户代理在决定如何使用推送的资源时可以考虑它们。

根据响应的某些部分排序 PUSH_PROMISE 帧很重要。服务器应该在发送引用承诺响应的 HEADERS 或 DATA 帧之前发送 PUSH_PROMISE 帧。这能够减少客户端请求即将由服务器推送的资源的机会。

由于重新排序，推送流数据可以在相应的 PUSH_PROMISE 帧之前到达。当客户端接收到具有未知推送 ID 的新推送流时，关联的客户端请求和推送的请求标头字段都是未知的。客户端可以缓冲流数据以期望后续能够出现匹配的 PUSH_PROMISE 。客户端可以使用流的流控制（[QUIC-TRANSPORT]第4.1节）来限制服务器可以提交到推送流的数据量。如果在合理的时间内没有处理相应的 USH_PROMISE 帧，客户端应该中止读取并丢弃已经从推送流中读取的数据。

推送流数据也可以在客户端取消推送后到达。在这种情况下，客户端可以以错误代码 H3_REQUEST_CANCELLED 中止读取的流。这要求服务器不要传输额外的数据，并表示收到后将被丢弃。

如果客户端实现了 HTTP 缓存，则可以存储可缓存的推送响应（参见[HTTP-CACHING]的第3节）。当接收到推送的响应时，推送的响应被认为在源服务器上已成功验证（例如，如果存在“无缓存”缓存响应指令；请参阅[HTTP-CACHING]的第5.2.2.4节）。

不可缓存的推送响应不得存储在任何HTTP缓存中。它们可以单独提供给应用程序。




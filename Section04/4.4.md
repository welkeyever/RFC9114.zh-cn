4.4. CONNECT方法
============================
CONNECT 方法请求接收方建立到由请求目标标识的目标源服务器的隧道；参见[HTTP]的第9.3.6节。它主要与 HTTP 代理一起用于与源服务器建立 TLS 会话，以便与“https”资源交互。

在 HTTP/1.x 中，CONNECT 用于将整个 HTTP 连接转换为到远程主机的隧道。在 HTTP/2 和 HTTP/3 中，CONNECT 方法用于在单个流上建立隧道。

CONNECT请求的构造必须遵循如下规则：

* :method 伪标头字段设置为“CONNECT”
* 省略 :scheme 和 :path 伪标头字段
* :authority 伪标头字段包含要连接的主机和端口（相当于CONNECT请求的请求目标的权限形式；参见[HTTP]的第7.1节）。

请求流在请求结束时也需要保持打开状态以携带需要传输的数据。不符合这个限制的 CONNECT 请求被视为格式错误。

一个代理如果支持 CONNECT 方法和服务端建立 TCP 连接，需要在 :authority 伪标头中标识。成功建立此连接后，代理会向客户端发送一个包含 2xx 系列状态码的 HEADERS 帧，如[HTTP]第15.3节所定义。

流上的所有 DATA 帧对应于在传输控制协议上发送或接收的数据。客户端发送的任何 DATA 帧的有效载荷由代理传输到 TCP 服务器；从 TCP 服务器接收到的数据由代理打包成 DATA 帧。注意，这里不保证 TCP
段的大小和数量可预测地映射到 HTTP DATA 或 QUIC STREAM 帧的大小和数量上。

CONNECT 方法完成后，只允许在流中发送 DATA 帧。如果扩展定义特别允许，可以使用扩展帧。任何其他已知帧类型的接收必须被视为 H3_FRAME_UNEXPECTED 类型的连接错误。

TCP 连接可以由任一对等方关闭。当客户端结束请求流时（即代理处的接收流进入“Data Recvd”状态），代理将在其与 TCP 服务器的连接上设置 FIN 位。当代理收到设置了 FIN 位的数据包时，它将关闭它发送给客户端的发送流。

在单个方向上保持半关闭的 TCP 连接不是无效的，但服务器通常处理不好这种情况，因此客户端不应该关闭流以发送，而他们仍然期望从 CONNECT 的目标接收数据。

一个 TCP 连接错误通过突然终止流来发出信号。代理将 TCP 中的任何错误（包括接收具有 RST 位集的 TCP 段）视为 H3_CONNECT_ERROR 类型的流错误。

相应地，如果代理检测到流或 QUIC 连接错误，它必须关闭传输控制协议。如果代理检测到客户端已重置流或中止从流中读取，则必须关闭 TCP
连接。如果流被重置或读取被客户端中止，代理应该在另一个方向上执行相同的操作，以确保流的两个方向都被取消。在所有这些情况下，如果底层 TCP 实现允许，代理应该发送一个设置了 RST 位的 TCP 段消息。

由于 CONNECT 能够创建了到任意服务器的隧道，因此支持 CONNECT 的代理应该将其使用限制为一组已知端口或安全请求目标列表；有关详细信息，请参阅[HTTP]的第9.3.6节。
5.2. 连接关闭 
============================
即使连接不空闲，任一端点都可以决定停止使用连接并启动优雅的连接关闭。端点通过发送GOAWAY帧来启动HTTP/3连接的正常关闭。GOAWAY帧包含一个标识符，该标识符向接收者指示在此连接中已经或可能处理的请求或推送的范围。服务器发送客户端发起的双向流ID；客户端发送推送ID。GOAWAY的发送者会拒绝具有指定标识符或更大标识符的请求或推送（第4.1.1节）。如果没有处理任何请求或推送，此标识符可能为零。

GOAWAY帧中的信息使客户端和服务器能够在关闭HTTP/3连接之前就接受哪些请求或推送达成一致。发送GOAWAY帧时，端点应该明确取消（参见第4.1.1节和第7.2.3节）标识符大于或等于所指示标识符的任何请求或推送，以清理受影响流的传输状态。当更多请求或推送到达时，端点应该继续这样做。

端点在收到对等方的GOAWAY帧后不得发起新请求或承诺对连接进行新推送。客户端可以建立新连接以发送其他请求。

一些请求或推送可能已经在传输中：¶
* 当接受到GOAWAY帧的时候，如果客户端已经发送了流ID大于或等于GOAWAY帧中包含的标识符的请求，则这些请求不会被处理。客户端可以安全地在不同的HTTP连接上重试未处理的请求。当服务器关闭连接时，无法重试请求的客户端会丢失所有正在传输的请求。小于来自服务器的GOAWAY帧中的流ID的流上的请求可能已被处理；在收到响应之前无法知道它们的状态，流被单独重置，接收到另一个GOAWAY，其流ID低于相关请求的流ID，或者连接终止。如果未处理这些请求，服务器可能会拒绝低于指定ID的流上的单个请求。
* 如果服务器在承诺推送后收到一个GOAWAY帧，且其标识符大于或等于承诺的推送ID，则服务器不会发送这些推送。

服务器应该在提前知道连接关闭时发送GOAWAY帧，即使提前通知很小，以便远程对等方可以知道请求是否已被部分处理。例如，如果HTTP客户端在服务器关闭QUIC连接的同时发送POST，如果服务器没有发送GOAWAY帧来指示它可能对哪些流采取了行动，客户端就无法知道服务器是否开始处理该POST请求。

端点可以发送指示不同标识符的多个GOAWAY帧，但每帧中的标识符不得大于任何先前帧中的标识符，因为客户端可能已经在另一个HTTP连接上重试了未处理的请求。接收到包含比先前接收到的更大标识符的GOAWAY必须被视为H3_ID_ERROR类型的连接错误。

尝试优雅地关闭连接的端点可以发送一个GOAWAY帧，其值设置为最大可能值（服务器为2^62-4，客户端为2^62-1）。这确保对等方停止创建新请求或推送。在为任何正在进行的请求或推送留出的时间到达后，端点可以发送另一个GOAWAY帧，指示它在连接结束前可能接受哪些请求或推送。这可以确保连接可以干净地关闭而不会丢失请求。

客户端在为其发送的GOAWAY中的Push ID字段选择值时具有更大的灵活性。值2^62-1表示服务器可以继续履行已经承诺的推送。较小的值表示客户端将拒绝推送ID大于或等于该值的推送。与服务器一样，只要指定的推送ID不大于之前发送的任何值，客户端可以发送后续GOAWAY帧。

即使GOAWAY指示给定的请求或推送在收到后不会被处理或接受，底层传输资源仍然存在。发起这些请求的端点可以取消它们以清理传输状态。

处理完所有接受的请求和推送后，端点可以允许连接空闲，也可以立即关闭连接。完成正常关闭的端点应该在关闭连接时使用H3_NO_ERROR错误代码。

如果客户端已将所有可用的双向流ID在请求侧消费完闭，则服务器无需发送GOAWAY帧，因为客户端无法发出进一步的请求了。